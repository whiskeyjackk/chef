#!/bin/bash

## Check for any issues with GitHub Enterprise backups.

BACKUP_DIR=<%= @ghe_backup_dir %>

#Look for any output in the error log.
if [ -s /var/log/ghe_backup_error.log ]
then
  echo "CRITICAL - Error output detected in /var/log/ghe_backup_error.log"
  exit 2
fi

#Look for incomplete backups which have silently failed.
#We want to look at the second most recent backup because the current one may still be running.
LAST_BACKUP=$(ls -tr "$BACKUP_DIR" | tail -3 | head -1)
if [ -e "$BACKUP_DIR""$LAST_BACKUP"/incomplete ]
then
  echo "CRITICAL - Last GHE backup $LAST_BACKUP is incomplete"
  exit 2
fi

#Make sure the backup actually has some data.
BACKUP_SIZE=$(du -s "$BACKUP_DIR""$LAST_BACKUP"/ | cut -f1)

#We expect the backup to be at least a couple GBs in size.  Currenlty it's ~4GB.
MIN_SIZE_TRESHOLD=2097152
if [ $MIN_SIZE_TRESHOLD -ge $BACKUP_SIZE ]
then
  echo "WARNING - Last GHE backup $LAST_BACKUP is below the size threshold"
  exit 1
fi
